# Lab 1

# ID2223 / HT2025

![](images/7d60ac45425548792c4fece729488102ac9eeecd83171613ba6630523cae9007.jpg)

# Air Quality Prediction Service

# Source Code and References for Lab 1

- Source Code for this project Github https://github.com/featuresbook/mlfs-book/  
See Chapter 3 in the "Building ML Systems with a Feature Store" book  
- Use a virtual environment (e.g., Conda) to manage your python dependencies on your laptop. See more info on how to manage your Python environment here.

# Serverless AI System that Predicts Air Quality for a Location

![](images/0796ecdcdafef66449bb0075483696507c266e398113befc894cd59a3b870f68.jpg)

#  Dashboard for Serverless AI System that Predicts Air Quality for a Location

![](images/f4eff6079f4253b384722cc920adf8d105e46ebe0bed01b5ca1bbbf2cd1d90c9.jpg)  
PM2.5 Predicted (Logarithmic Scale) for stockholm, stockholm-hornsgatan-108

# - First Steps

a. Create a free account on hopsworks.ai  
b. Create a free account on github.com (and optionally modal.com)

# - Tasks

a. Build and run a feature pipeline on Github Actions or Modal  
b. Run a training pipeline  
c. Build and run a batch inference pipeline on Github Actions or Modal  
d. Visualize your air quality predictions with a dashboard

# Register and Login to the Hopsworks Feature Store

![](images/eea710d26d2613ef19288af11d9bc8d5623d9c905b395d364e19f651ae5db5da.jpg)

# Use either

(1) Modal - needs a credit card to register  
(2) Github Actions - no credit card needed

# Register to Modal and Set up HOPSWORKS_API_KEY environment variable

![](images/8fa0254bdf089ef3239fb96348e18eebe337271731a25535fc68e70563b37be7.jpg)

<>Code

![](images/f6cb93df3fe488160e86b956eb9721c0c8da2c61dcd7484f2a028f45c90980d8.jpg)

Issues

![](images/ad30ee2dafad65c4035d8cf17c481ef99d482e203790db9b56182ff1c2ac4e5d.jpg)

Pull requests

![](images/0cd0448a41884e73fa1f8f195bfa722b649b6983b6153b31da94eb45974a627d.jpg)

Actions

![](images/ae30b039b24311933c5064cf3f10cc5670703313bc809c10331190fc21778e70.jpg)

Projects

![](images/190c674a480cc9d897ca2f134bb0274b8ab2b140f857e271038edc6a588d9e8f.jpg)

Wiki

![](images/5d6e126561cebee1dd9a53c597fc4897d727f125c7d352e63709563d4f521948.jpg)

Insights

![](images/3d777f1f90dc884f0add0d1cc7b49cebc4cd8a2323efe793300bf3312285da2b.jpg)

Settings

![](images/2cf64ab9c7efeec7d9fa4769c67a274cc7df96f1d8cfa432e8c1e7bc19be54e3.jpg)

General

# Actions secrets

New repository secret

Access

![](images/a8e220cb809ed53c16e651261c46eb9017d08441ba19daedd5e191a781d82c6c.jpg)

Collaborators and teams

![](images/983348ad789a93c9c78f9bdecbc4f50615966ade6e5cf636b31a02964af5d9f2.jpg)

Moderation options

Secrets are environment variables that are encrypted. Anyone with collaborator access to this repository can use these secrets for Actions.

Secrets are not passed to workflows that are triggered by a pull request from a fork. Learn more.

Code and automation

![](images/44bb0cd0dd75d849df4bc236608f9312a6451d84cf6c446fc74cdb21beeb659b.jpg)

Branches

![](images/833b283d00819e048e6dd1e1ae85cbd14e6d3389c8447c5fe82903b6b766572b.jpg)

Tags

![](images/49667a50a5163b4759dc881a06e2d01ce95d3b95e6e0fec7ff697ff3f42cc138.jpg)

Actions

![](images/9927ef685195fa7adbd74a36b8c66e1db7b5b3016701f183adbca4a3f8e68ec4.jpg)

Webhooks

![](images/4abd052217a9b154cd24714e948db0f517ddd35650f17171b45548c5ae342513.jpg)

Environments

![](images/ca6ed59a55c7a1a5b7716ca78a342c145f55e75bedf01ad1fd2b0ef1cbabf668.jpg)

Pages

Security

![](images/3b91060591393ab15ee07ea8b5cc0205f6b6df22203123024a62ae48b18692c0.jpg)

Code security and analysis

![](images/5e260c8e7b59b64444336af4108cf4014a6bd30d682bbf27c14f899fb53ae90e.jpg)

Deploy keys

![](images/2a284f05f4124140cbebe0d57ba206294616c88ff21bf9fd7c64725c27366026.jpg)

Secrets

Actions

Dependabot

Environment secrets

# There are no secrets for this repository's environments.

Encrypted environment secrets allow you to store sensitive information, such as access tokens, in your repository environments.

Manage your environments and add environment secrets

Add HOPSWORKS_API_KEY as a Repository secret under "Actions" (left-hand menu)

Repository secrets

![](images/cf1cc2c1cb46e8fa3f599044e19e06365f5a575da33834cb68d48d911282b02a.jpg)

HOPSWORKS_API_KEY

Updated 5 days ago

Update

Remove

# Enable the Github Actions for your Repository

<>Code

Pull requests

Actions

Project

Wiki

Security

Insights

Settings

![](images/481f9929f53b6fdea7e77c2f488b72af5b2fda995016f21781841d2874ab2d5a.jpg)

# Workflows aren't being run on this forked repository

Because this repository contained workflow files when it was forked, we have disabled them from running on this fork. Make sure you understand the configured workflows and their expected usage before enabling Actions on this repository.

I understand my workflows, go ahead and enable them

View the workflows directory

![](images/2dea0ced4255fb1f21549073bfcfb0349358a896db3d00bdb1aaa19e783039e4.jpg)

# Weather and

# Air Quality

# Data Sources

![](images/8924e3abc0636503492a2ef9bea227e3f7be5b5c0ee92aeaa54c52224e8ad125.jpg)

# Air Quality Data Source: https://aqicn.org

![](images/6b550774c053f7185bf81c49ec5f9e9b77c80419f4b57f813d6d60aa85850c05.jpg)

# https://aqicn.org

You should pick a sensor on this page - not the one in the book. Near your childhood home, country house, favorite place, wherever. It should have enough good quality measurements.

# Select 1 or more Air Quality Sensors with Good Quality Data

![](images/bf5f239933f7a73593d0201dc7924b038b40b5c553eb9f5513585a1dbaec4b00.jpg)

![](images/e1c883a693290127aef72bf64e5278a45ee11abd710ddf82ce7d426dab6fc8c4.jpg)

![](images/b35e41d0be0389597066dac98e9186265331821672a554678943c7a759d67d07.jpg)  
Air Quality Historical Data  
Historical Air Quality Index

![](images/896fe79cbf62e545cfacbb12ba678f2ad59de77ca35b93ffd4ef5260b386ebc3.jpg)  
Air quality monitoring station: Frösundaleden, Solna, Sweden [id 62563]  
Also known as Citizen Science project sensorcommunity/16147

![](images/a8eaaa3604881efaba246d93b4da5236018d2e3a9d266d7787309c3b45360aab.jpg)

# Free Weather API

Open-Meteor is an open-source weather API with free access for non-commercial use. No API key is required. You can use it immediately!

https://open-meteo.com/en/docs/air-quality-api

<table><tr><td>Dynamic Data Sources</td><td>Prediction Problem</td><td>UI or API</td><td>Monitoring</td></tr><tr><td>Air Quality Sensor Data: https://aqicn.info</td><td rowspan="2">Daily forecast of the level of PM2.5 for the next 7 days at the position of an existing air quality sensor.</td><td rowspan="2">A web page with graphs and a LLM-powered UI in Python.</td><td rowspan="2">Hindcast graphs show prediction performance of our model.</td></tr><tr><td>Weather Forecasts: https://open-meteo.com</td></tr></table>

<table><tr><td>‘A’ Grade</td><td>Provide predictions for all air quality sensors in a Swedish city. Select a city by entering your group number here. Your UI should show forecasts for all sensors in your chosen city.</td></tr></table>

# Weather Data Ingestion into Hopworks

```python
weather_df = # 1. read today's data in as a Pandas DataFrame
# 2. create features for in Pandas DataFrame
weather_fg = fs.get_or_create_feature_group(name="weather",
                          version=1,
                          description="Weather Daily Updates",
                          primary_key=['city'],
                          event_time='date')
)
```

Feature Group - weather  

<table><tr><td>city_name</td><td>date</td><td>wind_speed_max</td><td>windDirectionDominant</td><td>wind_gusts_max</td><td>temp_max</td><td></td><td></td></tr><tr><td>&lt;entity_id&gt;</td><td>&lt;event_time&gt;</td><td>&lt;numerical feature&gt;</td><td>&lt;categorical feature&gt;</td><td>&lt;numerical feature&gt;</td><td>&lt;numerical feature&gt;</td><td>Feature Types</td><td></td></tr><tr><td>string</td><td>datetime</td><td>double</td><td>string</td><td>double</td><td>double</td><td></td><td></td></tr><tr><td>berlin</td><td>2022-01-01</td><td>14.3</td><td>ne</td><td>22.4</td><td>22.7</td><td></td><td></td></tr><tr><td>dublin</td><td>2022-04-01</td><td>9.3</td><td>n</td><td>18.2</td><td>25.4</td><td>Row</td><td></td></tr><tr><td>seattle</td><td>2022-07-01</td><td>11.1</td><td>nw</td><td>15.2</td><td>20.8</td><td></td><td></td></tr><tr><td>tacoma</td><td>2022-10-01</td><td>1.3</td><td>w</td><td>2.5</td><td>28.4</td><td></td><td></td></tr><tr><td colspan="3">entity_id and event_time
uniquely identify each row.
They are not features.</td><td colspan="2">Feature value.
Store unencoded to
maximize reuse over
many models.</td><td colspan="3">Feature vector.
Set of feature values with
the same primary key.</td></tr></table>

# Air Quality Data Ingestion into Hopworks

air_quality_df = # 1. read the most recent air quality observations

2. create features for in Panda DataFrame

air_quality_fg = fs.get_or_create_feature_group(name="air_quality",

version=1,

description="City Air Quality Data",

primary_key = ['city'],

expectation-suite=expectation-suite,

event_time='date'

）

air_quality_fg.insert(air_quality_df) # 3. write DataFrame to Feature Group

#…

Feature Group - air_quality  

<table><tr><td>city_name</td><td>date</td><td>pm2_5</td></tr><tr><td>&lt;entity_id&gt;</td><td>&lt;event_time&gt;</td><td>&lt;numerical feature&gt;</td></tr><tr><td>string</td><td>datetime</td><td>double</td></tr><tr><td>berlin</td><td>2022-01-01</td><td>5.3</td></tr><tr><td>dublin</td><td>2022-04-01</td><td>2.3</td></tr><tr><td>seattle</td><td>2022-07-01</td><td>3.1</td></tr><tr><td>tacoma</td><td>2022-10-01</td><td>4.3</td></tr></table>

# Label

Column is the target for the prediction problem

# Scheduling a Feature Pipeline to run daily with Modal

```python
stub = modal.Stub("air_quality_daily")
```

```python
image = modal.Imagedebian_slim().pip_install(['hopworks'])
```

```txt
@stub.function(image  $\equiv$  image, schedule  $\equiv$  modal Period(days=1),
```

```txt
secret  $\equiv$  modalSecret.from_name("jim-hopworks-ai")
```

```txt
def g():
```

```txt
··
```

```python
if __name__ == "_main__":
```

```txt
stubdeploy("air_quality_daily")
```

```txt
with stub.run():
```

```txt
g()
```

# Scheduling a Feature Pipeline to run daily with Github Actions

```yaml
name: air-quality-daily
on:
    workflow_dispatch:
        schedule:
            - cron: '11 6 * *'
    jobs:
        schedule_pipelines:
            runs-on: ubuntulatest
...
    steps:
...
    - name: install python packages
        run: |
            cd notebooks/ch03
            python -m pip install --upgrade pip
            pip install -r requirements.txt
        - name: execute python workflows from bash script
            env:
                HOPSWORKS_API_KEY: ${ secrets.HOPSWORKS_API_KEY } }
            run: |
                cd notebooks/ch03
                jupyter nbconvert --to notebook --execute 2_air_quality_featurepipeline.ipynb
```

```python
fg_air_quality = fs.get_feature_group(name="air_quality", version=1)
```

```python
fg_weather = fs.get_feature_group(name="weather", version=1)
```

```txt
selected = fg_air_quality.select(['pm2_5').join(fg_weather.select_all()))
```

```python
fv = fs.create_feature_view(name="air_quality_fv",
```

```txt
version=1,
```

```txt
description="Weather and Air Quality",
```

```javascript
labels  $=$  ['pm2_5'],
```

```gitattributes
query=selected
```

```txt
）
```

# Training Pipeline

X_train, X_test, y_train, y_test = fv.train_test_split(test_size=0.2)

categorical_transformer  $\equiv$  Pipeline(steps  $=$  ["encoder"],

OneHotEncoder(handle_unknown="ignore"))])

preprocessor = ColumnTransformer(transformers = [ \

("cat", categorical_transformer, categorical_feature_ids)])

clf = Pipeline(steps= ["preprocessor", preprocessor], ("regressor",

XGBRegressor())])

clf.fit(X_train, y_train)

# Training Pipeline

joblib.dump(clf, 'air_quality_model/xgboostpipeline.pkl')

input_schema = Schema(X_test)

output_schema = Schema(y_test)

aq_model = mr sklearn.create_model("air_quality_model",

metrics  $=$  {'accuracy': accuracy},

input_example  $\equiv$  X_test.sample().to_numpy(),

model_schema  $\equiv$  ModelSchema(input_schema  $\equiv$  input_schema,

output_schema  $\equiv$  output_schema))

fraud_model.save('air_quality_model')

```python
fv = fs.get_feature_view(name="air_quality_fv", version=1)  
df = feature_view.get_batch_data(start_time=today)
```

```python
mr = project.get_modelregistry()
```

```python
model = mr.get_model("lending_model", version=1)
```

```python
model_dir = model.download()
```

```txt
model = joblib.load(model_dir + "/air_quality_model.pkl")
```

```txt
predictions_df = model.predict(df)
```

# Communicate the value of your model with a UI (Gradio)

- Communicate the value of your model to stakeholders with an app/service that uses the ML model to make value-added decisions  
Here, we design a UI as a Github Page ( a PNG file on a webpage - we use matplotlib to generate the PNG file)

o Shows predictions of air quality for a place for the next few days

![](images/7e7d99ab580628f0ebe274d95eeb94b378328b6c6949029e5548903ad1034e9a.jpg)  
PM2.5 Predicted (Logarithmic Scale) for stockholm, stockholm-hornsgatan-108

# Task: Air Quality Prediction using Weather Features

# Grade 'E' tasks

1. Write a backfill feature pipeline that downloads historical weather data (ideally  $>1$  year of data), loads a csv file with historical air quality data (downloaded from https://aqicn.org) and registers them as 2 Feature Groups with Hopworks.  
2. Schedule a daily feature pipeline notebook that downloads yesterday's weather data and air quality data, and also the weather prediction for the next 7-10 days and update the Feature Groups in Hopsworks. Use GH Actions or Modal.  
3. Write a training pipeline that (1) selects the features for use in a feature view, (2) reads training data with the Feature View, trains a regression or classifier model to predict air quality  $(pm25)$ . Register the model with Hopssworks.  
4. Write a batch inference pipeline that creates a dashboard. The program should download your model from Hopworks and plot a dashboard that predicts the air quality for the next 7-10 days for your chosen air quality sensor.  
5. Monitor the accuracy of your predictions by plotting a hindcast graph showing your predictions vs outcomes (measured air quality).

# Grade 'C' tasks

6. Update your Model by adding a new feature, lagged air quality for the previous 1 day, 2 days, and 3 days. Measure and explain the performance improvement or regression for these features.

# Grade 'A' tasks

7. Provide predictions for all air quality sensors in a Swedish city. Select a city by entering your group number here.

# Deliverables

- Deliver your source code as a Github Repository.  
- Deliver your lab description as a README.md file in the root of your project directory in your Github repository  
- Deliver a public URL for the Dashboard.

Deadline midnight 18th November 2025.

The lab will be graded during a defence of your lab held over Zoom in the week of November 18th. Available Zoom slots for defence will be published in Canvas.

# Grading

- The grade for this lab will be awarded if you (1) complete the tasks below, (2) and answer our questions during the grading defence.  
- As a guide to your grade, assuming you answer questions successfully, you can expect:

Steps 1-5: Grade E  
Steps 1-6: Grade C  
Steps 1-7: Grade A

# Alternative Dashboard developed in Python

- You can develop your own UI in Python if you prefer over GitHub Pages

Good frameworks are Gradio or Streamlit  
You can deploy them for free on a serverless platform like HuggingFace or Streamlit Cloud  
You can also vibe code your own UI - replit supports Python.

# Optional: Register and Create a Hugging Face Space

![](images/f89fc0427dd64254dfbcf4fc9396d565ec6006de8e2e425cff7f94533e364200.jpg)

Hugging Face

Search models, datasets, users...

![](images/317b9dbfb9b800b84c6a88200e9c7e04067eb82c71f5d84de9fb069ff18ce6ea.jpg)

# Spaces

Discover amazing ML apps made by the community!

![](images/dc7d0eaf1749f11b9783ffa5ee94178384d2ff18e671c3607c4696ddac559c38.jpg)

Models

![](images/c4c46aa1fef7d9b09ccd0c5e7d5bdb83d0887676c977dd875a5ee65ed4703a15.jpg)

Datasets

![](images/c8204f9cc00ea622844738c4dfe5a0fa6f1d2469873f0a68146bb0f498e8ea9b.jpg)

Spaces

![](images/b95affef56c22e186d0744a4675dec2a14ea39ee2b3045d1ef01ae37eefe76d1.jpg)

ocs

![](images/4075ac993c6d6a3b36bfe545c987666121fb3614bdeb258c8ce4a1d3c78dc624.jpg)

s Pricing

![](images/18103c0c55905d5c21b4936387dc118ba6f912ca01700a0dec0d806062642310.jpg)

三

![](images/fcee6534236c41730780cc0725f3f1bde1b4f2d7faba18e0d934714080de0be5.jpg)

Create new Space

or learn more about Spaces.

1. Create an account on Hugging Face  
2. Create a "Space"

![](images/ccf2543250d7fae46d66d22fbeccd5d5db5ebe4bcf4508a5d3a53c12f00dc0c8.jpg)

# Create a new Space

A Space is a special kind of repository that hosts application code for Machine Learning demos

Those applications can be written using Python libraries like Streamlit or Gradio

Owner

jdowling

Space name

#

iris

License

apache-2.0

Select the Space SDK

You can chose between Streamlit, Gradio and Static for your Space. Contact us if you need a custom solution.

![](images/55b871d809c316417e0cc56c236af0837270cc3c0487e41d461c93d8b780144f.jpg)

Streamlit

![](images/c10b7f64fd7f0fb8a434f17025d2eff44f50f560f85158c51214051fe73986f0.jpg)

Gradio

![](images/395bb479fd103699512f8cdf8e08b771a7415d7c705345cd743cc32de6c91ad3.jpg)

Static

![](images/58c383d46c0160fa9fb612d41a2a74098624f495a528973fd06c8b11e72c63b8.jpg)

Public

Anyone on the internet can see this space. Only you (personal space) or members of your organization (organization space) can commit.

![](images/802684af5872f8f5b3b2c7b9781ed1e7dd084e1aaa93bb6b7891ddbf6cc487c9.jpg)

Private

Only you (personal space) or members of your organization (organization space) can see and commit to this space.

Create space

3. Create a Gradio App with the name Iris inside your account

# Add a HOPSWORKS_API_KEY as a secret in your Space

![](images/3984c5d1f75af8c19b34055d55fd532709814f70a5eddd58c2643360ace6598f.jpg)

# Hugging Face

Search models, datasets, users...

Models

Datasets

Spaces

Docs

Solutions

Pricing

#

![](images/533153180f114a777ab9b3b42adb109bc46aed27ed523209ea7a4c6c1057e693.jpg)

Spaces:

![](images/fd12c4df08a7151bacd8a1258d81c7dc98ee5e758f01fe34b48cb11402e52711.jpg)

owling

![](images/d60c3b82b67a193542475b29df0edebed48e65851c8c6b75f2fb2a25f6d9dde2.jpg)

#

![](images/dfed25aed1d94bf5df2974b79052843620fb40978293dcbaa54e0f8dbbe99792.jpg)

Running

View logs

App

![](images/8ace6ccb45e83fde749aa7db47a844faa04619574d296aeb9d342e16ee52aa4d.jpg)

es and versions

Con

nity 9

ngs

![](images/6c6dd67be4ee9a668d4074e934b2b112a746e16ac78f266fa39d587480d36e50.jpg)

![](images/fadecfbae23a7ac9ac6b1f50b7c80f031b02bef73e7927887c9516696fa57357.jpg)

# Space Hardware

Choose a hardware for your Space.

You'll be billed on a per minute basis.

View usage in your billing settings.

Display price: per hour per month

Building something cool as a side project?

Apply for a community GPU grant .

# CPU basic

2 vCPU 16 GiB RAM

Current  $\cdot$  Free

# T4 small

4 vCPU - 15 GiB RAM - Nvidia T4

$0.6/hour

# CPU upgrade

8 vCPU·32 GiB RAM

$0.03/hour

# T4 medium

8 vCPU 30 GiB RAM Nvidia T4

$0.9/hour

# A10G small

4 vCPU - 15 GiB RAM - Nvidia A10G

$1.05/hour

# A10G large

12 vCPU 46 GiB RAM Nvidia A10G

3.15/hour

# AI Accelerator

HPU·IPU…

Coming soon

Repo secrets

HOPSWORKS_API_KEY

1. Add your HOPSWORKS_API_KEY as a Repo Secret

Remove
